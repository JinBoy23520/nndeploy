# nndeploy Mac M4 部署总结

**部署日期**: 2026年1月6日  
**系统**: macOS 15.3.1 ARM64 (Apple M4)  
**版本**: nndeploy 3.0.8

---

## 一、系统环境

### 1.1 基础信息
- **操作系统**: macOS 15.3.1 (Darwin 24.3.0)
- **架构**: ARM64 (Apple Silicon M4)
- **Python**: 3.14.2 (`/opt/homebrew/bin/python3`)
- **CMake**: 4.2.0
- **编译器**: AppleClang 17.0.0.17000013

### 1.2 Homebrew 依赖包
```bash
brew install opencv protobuf cmake git wget curl unzip
```

已安装版本：
- **OpenCV**: 4.12.0_17 (`/opt/homebrew/Cellar/opencv/4.12.0_17`)
- **Protobuf**: 33.1
- **Rust**: 1.84.0 (cargo 工具链)

---

## 二、依赖库编译

### 2.1 MNN 推理引擎
**版本**: 3.2.4  
**安装方法**:
```bash
cd /Users/jin/work/nndeploy-1/tool/script
python3 install_mnn.py
```

**安装位置**:
- 库文件: `tool/script/third_party/mnn3.2.4/lib/`
- 头文件: `tool/script/third_party/mnn3.2.4/include/`

### 2.2 tokenizers_cpp 文本处理
**版本**: 0.2.00  
**编译方法**:
```bash
cd /Users/jin/work/nndeploy-1/third_party/tokenizers-cpp
mkdir -p build && cd build
cmake .. -DCMAKE_BUILD_TYPE=Release \
         -DCMAKE_OSX_ARCHITECTURES=arm64 \
         -DTOKENIZERS_CPP_BUILD_PYTHON_BINDINGS=OFF
make -j8
```

**编译产物**:
- 静态库: `third_party/tokenizers-cpp/build/libtokenizers_cpp.a`
- 头文件: `third_party/tokenizers-cpp/include/tokenizers_cpp.h`

**编译时间**: ~18秒

---

## 三、nndeploy 编译配置

### 3.1 CMake 配置修改

**修改文件**: `CMakeLists.txt` (第646-649行)

添加 tokenizers_cpp 头文件路径：
```cmake
include_directories(
  ${CMAKE_CURRENT_SOURCE_DIR}/third_party/tokenizers-cpp/include
  ${CMAKE_CURRENT_SOURCE_DIR}/third_party/tokenizers-cpp/sentencepiece/src
)
```

### 3.2 编译命令
```bash
# 清理并重建 build 目录
rm -rf build && mkdir build && cd build

# CMake 配置
cmake .. \
  -DCMAKE_BUILD_TYPE=Release \
  -DENABLE_NNDEPLOY_OPENCV=ON \
  -DENABLE_NNDEPLOY_PLUGIN_TOKENIZER_CPP=ON

# 编译（使用8线程）
make -j8

# 安装
make install
```

### 3.3 启用的功能模块
- ✅ **OpenCV**: 图像编解码、预处理
- ✅ **tokenizers_cpp**: 文本分词、NLP任务
- ✅ **MNN**: 推理后端
- ✅ **Python 绑定**: Python 3.14 接口

---

## 四、编译产物

### 4.1 安装目录结构
```
/Users/jin/work/nndeploy-1/build/nndeploy_3.0.8_Darwin_arm64_Release_AppleClang/
├── lib/                          # C++ 库文件
│   ├── libnndeploy_framework.a
│   ├── libnndeploy_plugin.a
│   └── cmake/                    # CMake 配置文件
├── include/                      # 头文件
│   ├── nndeploy/
│   └── msgpack/
└── bin/                          # 可执行文件（如有）
```

### 4.2 Python 模块
```
/Users/jin/work/nndeploy-1/build/python/
├── nndeploy/                     # Python 包
│   ├── __init__.py
│   └── _nndeploy_internal.cpython-314-darwin.so  # C++ 扩展
```

### 4.3 Demo 程序
编译生成的示例程序（位于 `build/` 目录）：
- `nndeploy_demo_classification` - 图像分类
- `nndeploy_demo_detect` - 目标检测
- `nndeploy_demo_segment` - 图像分割
- `nndeploy_demo_ocr` - 光学字符识别
- `nndeploy_demo_track` - 目标跟踪
- `nndeploy_demo_matting` - 图像抠图
- `nndeploy_demo_llm` - 大语言模型
- `nndeploy_demo_tokenizer_cpp` - 分词器测试

---

## 五、启动服务与使用

### 5.1 Python 使用方式

#### 方法一：临时导入
```python
import sys
sys.path.insert(0, '/Users/jin/work/nndeploy-1/build/python')

import nndeploy
print(f"nndeploy 版本: {nndeploy.__version__}")  # nndeploy 3.0.8
```

#### 方法二：环境变量（推荐）
```bash
# 添加到 ~/.zshrc 或 ~/.bash_profile
export PYTHONPATH="/Users/jin/work/nndeploy-1/build/python:$PYTHONPATH"

# 立即生效
source ~/.zshrc
```

然后可以直接导入：
```python
import nndeploy
```

#### 方法三：安装到 site-packages
```bash
cd /Users/jin/work/nndeploy-1
pip install -e .  # 开发模式安装
```

### 5.2 C++ 使用方式

#### 编译链接示例
```cmake
# CMakeLists.txt
find_package(nndeploy REQUIRED 
  PATHS /Users/jin/work/nndeploy-1/build/nndeploy_3.0.8_Darwin_arm64_Release_AppleClang/lib/cmake)

target_link_libraries(your_target 
  nndeploy::framework
  nndeploy::plugin
)
```

#### 直接链接
```bash
g++ -std=c++17 your_app.cpp \
  -I/Users/jin/work/nndeploy-1/build/nndeploy_3.0.8_Darwin_arm64_Release_AppleClang/include \
  -L/Users/jin/work/nndeploy-1/build/nndeploy_3.0.8_Darwin_arm64_Release_AppleClang/lib \
  -lnndeploy_framework -lnndeploy_plugin \
  -o your_app
```

### 5.3 运行 Demo 示例

#### 图像分类
```bash
cd /Users/jin/work/nndeploy-1/build
./nndeploy_demo_classification \
  --model_path ../models/mobilenet_v2.onnx \
  --image_path ../test_data/cat.jpg
```

#### 目标检测
```bash
./nndeploy_demo_detect \
  --model_path ../models/yolov5s.onnx \
  --image_path ../test_data/street.jpg \
  --output_path ./output.jpg
```

#### LLM 推理（需要 MNN）
```bash
./nndeploy_demo_llm \
  --model_path ../models/qwen.mnn \
  --prompt "你好，介绍一下自己"
```

### 5.4 启动 Web 服务（如果有）

#### Flask/FastAPI 服务
如果项目包含 `app.py` 或 `server/` 目录：
```bash
cd /Users/jin/work/nndeploy-1

# 安装依赖
pip install flask fastapi uvicorn

# 启动服务
python3 app.py
# 或
uvicorn server.main:app --host 0.0.0.0 --port 8000
```

访问地址: `http://localhost:8000`

---

## 六、验证测试

### 6.1 Python 导入测试
```bash
cd /Users/jin/work/nndeploy-1/build
python3 -c "import sys; sys.path.insert(0, 'python'); import nndeploy; print(nndeploy.__version__)"
```

**期望输出**: `nndeploy 3.0.8`

### 6.2 功能模块测试
```python
import sys
sys.path.insert(0, '/Users/jin/work/nndeploy-1/build/python')
import nndeploy

# 检查可用模块
print("Base:", hasattr(nndeploy, 'base'))
print("Device:", hasattr(nndeploy, 'device'))
print("Net:", hasattr(nndeploy, 'net'))
print("Inference:", hasattr(nndeploy, 'inference'))
print("Codec:", hasattr(nndeploy, 'codec'))
print("Tokenizer:", hasattr(nndeploy, 'tokenizer'))
```

### 6.3 OpenCV 集成测试
```python
import nndeploy
# 测试 OpenCV 编解码功能
# decoder = nndeploy.codec.create_opencv_decoder(...)
```

---

## 七、常见问题与解决

### 7.1 导入错误
**问题**: `ModuleNotFoundError: No module named 'nndeploy'`

**解决**:
```bash
# 检查路径
ls /Users/jin/work/nndeploy-1/build/python/nndeploy/

# 添加到 PYTHONPATH
export PYTHONPATH="/Users/jin/work/nndeploy-1/build/python:$PYTHONPATH"
```

### 7.2 动态库加载失败
**问题**: `Library not loaded: @rpath/...`

**解决**:
```bash
# 设置库搜索路径
export DYLD_LIBRARY_PATH="/opt/homebrew/lib:$DYLD_LIBRARY_PATH"
```

### 7.3 重新编译
如果需要重新编译：
```bash
cd /Users/jin/work/nndeploy-1
rm -rf build
mkdir build && cd build
cmake .. -DCMAKE_BUILD_TYPE=Release \
         -DENABLE_NNDEPLOY_OPENCV=ON \
         -DENABLE_NNDEPLOY_PLUGIN_TOKENIZER_CPP=ON
make -j8
make install
```

---

## 八、性能优化建议

### 8.1 编译优化
```cmake
# 启用更多优化选项
-DCMAKE_BUILD_TYPE=Release \
-DCMAKE_CXX_FLAGS="-O3 -march=armv8.5-a" \
-DENABLE_NNDEPLOY_OPENMP=ON
```

### 8.2 运行时优化
- 使用 **MNN** 作为推理后端（已启用）
- 启用 Metal GPU 加速（如果 MNN 支持）
- 合理设置线程数：`export OMP_NUM_THREADS=8`

---

## 九、项目路径速查

| 项目 | 路径 |
|------|------|
| 工程根目录 | `/Users/jin/work/nndeploy-1` |
| CMake 构建目录 | `/Users/jin/work/nndeploy-1/build` |
| Python 模块 | `/Users/jin/work/nndeploy-1/build/python` |
| C++ 库安装 | `/Users/jin/work/nndeploy-1/build/nndeploy_3.0.8_Darwin_arm64_Release_AppleClang` |
| Demo 程序 | `/Users/jin/work/nndeploy-1/build/nndeploy_demo_*` |
| MNN 库 | `/Users/jin/work/nndeploy-1/tool/script/third_party/mnn3.2.4` |
| tokenizers_cpp | `/Users/jin/work/nndeploy-1/third_party/tokenizers-cpp/build` |

---

## 十、下一步计划

### 10.1 功能扩展
- [ ] 添加 ONNX Runtime 后端支持
- [ ] 集成更多模型示例
- [ ] 开发 REST API 服务
- [ ] 添加性能基准测试

### 10.2 文档完善
- [ ] 编写详细的 API 文档
- [ ] 添加更多使用示例
- [ ] 创建 Jupyter Notebook 教程

### 10.3 测试覆盖
- [ ] 单元测试
- [ ] 集成测试
- [ ] 性能测试

---

## 十一、技术支持

- **官方仓库**: https://github.com/DeployAI/nndeploy
- **文档**: https://nndeploy.readthedocs.io
- **问题反馈**: 提交 GitHub Issue

---

**编译完成时间**: 2026年1月6日  
**编译状态**: ✅ 成功  
**总耗时**: 约10分钟（含依赖下载和编译）
