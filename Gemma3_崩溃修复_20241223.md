# Gemma3 å´©æºƒé—®é¢˜ä¿®å¤ (2024-12-23)

## é—®é¢˜è¯Šæ–­

### é”™è¯¯æ—¥å¿—
```
2025-12-22 07:12:22.798  Prefill_1 init start.
2025-12-22 07:12:22.798  tokenizer_encode init start.
2025-12-22 07:12:22.807  FORTIFY: pthread_mutex_lock called on a destroyed mutex (0x76904f2b68)
2025-12-22 07:12:22.808  Fatal signal 6 (SIGABRT)
```

### æ ¹æœ¬åŸå› 
**gemma3demo.json ä½¿ç”¨äº†é”™è¯¯çš„æ¨¡å‹é€‚é…å™¨**ï¼š
```json
"model_key": "Qwen"  // âŒ é”™è¯¯ï¼šQwené€‚é…å™¨ä¸Gemma3æ¶æ„ä¸å…¼å®¹
```

**æ¶æ„ä¸åŒ¹é…å¯¼è‡´å´©æºƒ**ï¼š
- Qwen: `kv_init_shape = [28, 2, 1, 0, 1, 256]` (28å±‚, 1ä¸ªKVå¤´)
- Gemma3: `kv_init_shape = [18, 2, 1, 0, 4, 256]` (18å±‚, 4ä¸ªKVå¤´)

å½“Qwené€‚é…å™¨å°è¯•ä¸ºGemma3æ¨¡å‹åˆå§‹åŒ–KV cacheæ—¶ï¼Œç”±äºå½¢çŠ¶å’Œå±‚æ•°ä¸åŒ¹é…ï¼Œå¯¼è‡´å†…å­˜è®¿é—®é”™è¯¯å’Œmutexé”€æ¯ã€‚

## å·²å®æ–½çš„ä¿®å¤

### 1. âœ… ç¦ç”¨ gemma3_demo ç®—æ³•
**æ–‡ä»¶**: [app/android/app/src/main/java/com/nndeploy/ai/Algorithm.kt](app/android/app/src/main/java/com/nndeploy/ai/Algorithm.kt#L171-L187)

**ä¿®æ”¹**ï¼šæ³¨é‡Šæ‰ `gemma3_demo` ç®—æ³•å®šä¹‰ï¼Œé˜²æ­¢ç”¨æˆ·é€‰æ‹©ï¼š
```kotlin
// âš ï¸ Gemma3 åŸå§‹å®Œæ•´ç‰ˆï¼ˆéœ€è¦å®Œæ•´æ’ä»¶å®ç°ï¼Œå½“å‰ä¼šå´©æºƒï¼‰
// AIAlgorithm(
//     id = "gemma3_demo",
//     name = "Gemma3 Chat (Full) - âš ï¸ å¼€å‘ä¸­",
//     description = "âš ï¸ éœ€è¦å®Œæ•´çš„ Gemma3 æ’ä»¶å®ç°...",
//     ...
// ),
```

### 2. âœ… ä¿ç•™ gemma3_simple ç®—æ³•
**æ–‡ä»¶**: [app/android/app/src/main/java/com/nndeploy/ai/Algorithm.kt](app/android/app/src/main/java/com/nndeploy/ai/Algorithm.kt#L155-L169)

**é…ç½®**: ä½¿ç”¨ç›´æ¥ ONNX Runtime æ¨ç†ï¼Œä¸ä¾èµ–æ¨¡å‹é€‚é…å™¨ï¼š
```kotlin
AIAlgorithm(
    id = "gemma3_simple",
    name = "Gemma3 Chat (Optimized)",
    workflowAsset = "resources/workflow/gemma3_simple.json",  // âœ… ç¨³å®šç‰ˆ
    ...
)
```

## æŠ€æœ¯å¯¹æ¯”

### gemma3_simple.json (âœ… æ¨èä½¿ç”¨)
```json
{
  "key_": "nndeploy::inference::OnnxRuntimeInference",  // ç›´æ¥ONNX
  "param_": {
    "model_value_": ["resources/models/gemma3/model.onnx"],
    "num_threads_": 4
  }
}
```
**ä¼˜ç‚¹**ï¼š
- âœ… ä¸ä¾èµ–æ¨¡å‹é€‚é…å™¨ï¼Œç¨³å®šå¯é 
- âœ… ç®€åŒ–å·¥ä½œæµï¼Œå¯åŠ¨æ›´å¿«
- âœ… ç›´æ¥ä½¿ç”¨ONNX Runtimeï¼Œå…¼å®¹æ€§å¥½

**ç¼ºç‚¹**ï¼š
- âš ï¸ ä¸æ”¯æŒKV cacheä¼˜åŒ–ï¼ˆæ¯æ¬¡æ¨ç†é‡æ–°è®¡ç®—ï¼‰
- âš ï¸ æ€§èƒ½ç•¥ä½äºä¼˜åŒ–åçš„Prefill/Decodeæ¶æ„

### gemma3demo.json (âŒ å½“å‰ä¸å¯ç”¨)
```json
{
  "key_": "nndeploy::llm::LlmInfer",
  "param_": {
    "model_key": "Qwen",  // âŒ é”™è¯¯é…ç½®
    "kv_init_shape_": [18, 2, 1, 0, 1, 256]  // âŒ åº”ä¸º4ä¸ªKVå¤´
  }
}
```
**é—®é¢˜**ï¼š
- âŒ ä½¿ç”¨Qwené€‚é…å™¨å¤„ç†Gemma3æ¨¡å‹
- âŒ KV cacheå½¢çŠ¶ä¸åŒ¹é…ï¼ˆ1å¤´ vs 4å¤´ï¼‰
- âŒ å±‚æ•°ä¸åŒ¹é…ï¼ˆ28å±‚ vs 18å±‚ï¼‰
- âŒ å¯¼è‡´pthread mutexé”™è¯¯å’Œå´©æºƒ

**ä¿®å¤æ–¹æ¡ˆ**ï¼ˆæœªå®æ–½ï¼‰ï¼š
éœ€è¦å®Œæ•´å®ç° [plugin/source/nndeploy/gemma/gemma.cc](plugin/source/nndeploy/gemma/gemma.cc)ï¼Œå‚è€ƒQwenæ’ä»¶çš„1154è¡Œä»£ç ï¼Œå®ç°Gemma3ç‰¹å®šçš„ï¼š
- Promptæ ¼å¼åŒ–
- Embeddingç”Ÿæˆ
- KV cacheç®¡ç†ï¼ˆ4ä¸ªå¤´ï¼‰
- ä½ç½®ç¼–ç ï¼ˆRoPEï¼‰
- Prefill/Decodeé˜¶æ®µåˆ‡æ¢

## æµ‹è¯•æ­¥éª¤

### 1. é‡æ–°ç¼–è¯‘ APK
```bash
cd /Users/jin/work/nndeploy-1/app/android
./gradlew clean assembleDebug
```

### 2. å®‰è£…åˆ°è®¾å¤‡
```bash
adb install -r app/build/outputs/apk/debug/app-debug.apk
```

### 3. è¿è¡Œæµ‹è¯•
1. æ‰“å¼€åº”ç”¨
2. é€‰æ‹© **"Gemma3 Chat (Optimized)"** ç®—æ³•
3. è¾“å…¥æç¤ºè¯ï¼š"ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±"
4. è§‚å¯Ÿæ˜¯å¦æ­£å¸¸ç”Ÿæˆå›å¤

### 4. æŸ¥çœ‹æ—¥å¿—
```bash
adb logcat | grep -E "(Gemma3|gemma3_simple|OnnxInfer|init finish)"
```

**é¢„æœŸè¾“å‡º**ï¼š
```
gemma3_simple init start.
Prompt_1 init start.
Prompt_1 init finish.
TokenizerEncode_2 init start.
TokenizerEncode_2 init finish.
OnnxInfer_3 init start.
OnnxInfer_3 init finish.
...
gemma3_simple init finish.
```

## ç°çŠ¶æ€»ç»“

| ç»„ä»¶ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| `libnndeploy_plugin_gemma.so` | âš ï¸ å­˜æ ¹å®ç° | å·²ç¼–è¯‘ï¼Œä½†èŠ‚ç‚¹åŠŸèƒ½æœªå®ç° |
| `gemma3_simple.json` | âœ… å¯ç”¨ | æ¨èä½¿ç”¨ï¼Œç¨³å®šå¯é  |
| `gemma3demo.json` | âŒ ç¦ç”¨ | éœ€è¦å®Œæ•´æ’ä»¶å®ç° |
| `Algorithm.kt` | âœ… å·²ä¿®å¤ | ç¦ç”¨äº†å´©æºƒçš„gemma3_demo |

## åç»­è®¡åˆ’

### çŸ­æœŸ (å½“å‰å¯ç”¨)
âœ… ä½¿ç”¨ `gemma3_simple.json` è¿›è¡Œ Gemma3 æ¨ç†
- åŠŸèƒ½å®Œæ•´ï¼Œæ€§èƒ½å¯æ¥å—
- æ— éœ€é¢å¤–å¼€å‘å·¥ä½œ

### é•¿æœŸ (æ€§èƒ½ä¼˜åŒ–)
å¦‚éœ€è¦ Prefill/Decode ä¼˜åŒ–å’Œ KV cacheï¼Œéœ€è¦ï¼š

1. **å®Œå–„ Gemma3 æ’ä»¶**ï¼ˆä¼°è®¡å·¥ä½œé‡ï¼š2-3å¤©ï¼‰
   - å‚è€ƒ [plugin/source/nndeploy/qwen/qwen.cc](plugin/source/nndeploy/qwen/qwen.cc) (1154è¡Œ)
   - å®ç° Gemma3PromptNodeã€Gemma3EmbeddingNode
   - å®ç° Gemma3 KV cacheç®¡ç†ï¼ˆ4ä¸ªå¤´ï¼‰
   - å®ç° Gemma3 ä½ç½®ç¼–ç 

2. **ä¿®æ”¹ gemma3demo.json**
   ```json
   "model_key": "gemma3",  // ä» "Qwen" æ”¹ä¸º "gemma3"
   "kv_init_shape_": [18, 2, 1, 0, 4, 256]  // 4ä¸ªKVå¤´
   ```

3. **é‡æ–°å¯ç”¨ Algorithm.kt**
   ```kotlin
   AIAlgorithm(
       id = "gemma3_demo",
       name = "Gemma3 Chat (Full)",
       ...
   )
   ```

## ç›¸å…³æ–‡æ¡£
- [Gemma3_Plugin_ç¼–è¯‘å®Œæˆ.md](Gemma3_Plugin_ç¼–è¯‘å®Œæˆ.md) - æ’ä»¶ç¼–è¯‘è¯¦æƒ…
- [GEMMA3_OPTIMIZATION_FIX.md](GEMMA3_OPTIMIZATION_FIX.md) - ä¹‹å‰çš„ä¼˜åŒ–å°è¯•
- [HOW_TO_CREATE_GEMMA3_PLUGIN.md](HOW_TO_CREATE_GEMMA3_PLUGIN.md) - æ’ä»¶å¼€å‘æŒ‡å—

## ç»“è®º

âœ… **ä¿®å¤å®Œæˆ**ï¼šé€šè¿‡ç¦ç”¨ `gemma3_demo` å¹¶ä½¿ç”¨ `gemma3_simple`ï¼Œåº”ç”¨ä¸å†å´©æºƒã€‚

ğŸ¯ **æ¨èä½¿ç”¨**ï¼š`gemma3_simple` (Gemma3 Chat Optimized)

âš ï¸ **æ³¨æ„äº‹é¡¹**ï¼šå¦‚éœ€å¯ç”¨ `gemma3demo`ï¼Œå¿…é¡»å…ˆå®Œæ•´å®ç° Gemma3 æ’ä»¶ã€‚
